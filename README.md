# 목차
- [서비스 소개](#서비스-소개)
  * 졸라바요
- [프로젝트 구성 안내](#프로젝트-구성-안내)
  * 1. 프로젝트 아키텍처
  * 2. DB diagram
- [고민했던 포인트](#고민했던-포인트)
  * 1. AWS S3 저장소 로직과 DB 로직 트랜잭션 분리
  * 2. 청첩장을 받은 사용자만 해당 청첩장에 접근하도록 설계

<br>

# 서비스 소개
### 졸라바요
- 예비 신랑 신부가 결혼식 청첩장을 만들고 공유할 수 있는 서비스입니다.
- 청첩장을 보낼 때 사진과 자신이 받고 싶은 선물 목록을 같이 보낼 수 있습니다.
- 청첩장을 받은 사람은 결혼식 정보, 신랑 신부 사진 및 선물 정보를 통해 원하는 선물에 축의금을 얼마 보낼 지 작성할 수 있습니다.
- 청첩장을 받은 사람은 해당 결혼식 참석 여부를 선택할 수 있습니다.
- 예비 신랑 신부는 청첩장을 받은 사람들의 참석 여부와 선물에 보낼 축의금 정보를 통해 결혼식 준비를 편하게 할 수 있습니다.

<br>


# 프로젝트 구성 안내
  ### 1. 프로젝트 아키텍처

ec2-application 서버에는 실제 Spring Boot Application과 로그 수집에 필요한 promtail 서비스가 컨테이너 형태로 띄워져 있습니다.

ec2-monitoring 서버에는 해당 어플리케이션을 관제할 수 있는 스택들인 prometheus, loki, grafana 서비스가 컨테이너 형태로 띄워져 있습니다.

AWS S3 객체의 경우 어플리케이션을 통해 쓰기, 읽기가 가능하며

Public으로 읽기에 대해서만 오픈했기 때문에 클라이언트에서 해당 이미지를 직접 받아올 수 있도록 설계했습니다.

<br>
<centor><img src="https://github.com/Wedding-Registry/Back/assets/91299082/84da987e-e796-4c7f-8bcf-ddf561f62067.png" width="80%" height="80%">


  ### 2. DB diagram

users 테이블에서 자기 자신을 참조하도록 users_id와 parent_id를 둔 이유는

이후에 만약 신랑 신부가 전부 서비스에 가입을 한 경우 서로가 부부임을 확인하기 위해 설정하였습니다.

boards 테이블에 uuid_first, uuid_second 컬럼은 해당 예비 신랑, 신부의 게시판에 해당하는 청첩장을 전달할 때

단 하나의 값과 초대되지 않은 다른 신랑, 신부의 청첩장에 접근하는 것을 막기 위해 추가했습니다.


<br>
<centor><img src="https://github.com/Wedding-Registry/Back/assets/91299082/adcbf563-5e84-4608-afcf-628975cb8cd9.png" width="100%" height="100%">

<br>


# 고민했던 포인트
  <b>1. AWS S3 저장소 로직과 DB 로직 트랜잭션 분리</b>

<br>
갤러리 이미지를 삭제하고 저장할때 AWS S3를 이용해 이미지 파일을 저장하고 삭제하였는데 해당 로직에서 S3에 저장 후 DB에도 이미지 URL을 저장해야 하는 로직이 있었습니다.

이때 S3관련 로직에는 트랜잭션을 포함할 이유가 없었기 때문에 해당 부분과 DB 로직 부분의 트랜잭션을 분리하여 구현했습니다.

이때, DB에 저장하다 오류로 인해 롤백 되는 경우 S3에 저장한 이미지도 삭제하거나, 메모리에 따로 저장하여 하루에 한 번 배치를 돌면서 삭제하도록 구현했습니다.

해당 방법을 통해 S3 저장소와 DB의 저장 내용을 일치시킬 수 있었고 트랜잭션을 분리하여 DB 커넥션을 낭비하지 않도록 개발했습니다.

더욱 자세한 내용은 아래 블로그 글을 통해 확인할 수 있습니다.

<a href="https://jinmook.tistory.com/24" target="_blank">AWS S3 이미지 저장 및 삭제와 DB로직 트랜잭션 분리</a><br>


<br>
  <b>2. 청첩장을 받은 사용자만 해당 청첩장에 접근하도록 설계</b>
  
<br>
<br>
<b>[uuid를 통해 초대받은 청첩장만 접속하도록 구현]</b>
<br></br>

예비 신랑, 신부가 카카오톡이나 문자를 통해 청첩장을 전달하게 되면, 이때 처음에는 전달하는 청첩장의 도메인에 boards_id 값을 path parameter로 넣는것을 고민했습니다.

하지만 이럴 경우 사용자가 임의로 path parameter를 수정하여 접근하게 된다면 초대받지 않은 청첩장에도 접근할 수 있는 문제가 발생할 것으로 생각했습니다.

따라서 boards_id 보다는 랜덤 값인 uuid를 사용하고 정말 혹시 몰라서 uuid를 2개 사용하여 다른 청첩장에는 거의 접근하지 못하도록 만들었습니다.

<br>
<br>
<b>[http header에 특정 토큰 값을 추가하여 초대받은 사용자가 guests 테이블에 저장되어 있는지 확인]</b>
<br></br>

청첩장에서 사용자에게 요청이 오는 경우 매번 해당 사용자가 게스트 테이블에 저장되었는지 확인하기 보다는 저장되었다는 정보를 토큰값으로 전달하기로 했습니다.

따라서 청첩장에서 최초 요청이 있는 경우만 테이블에서 확인하고 이후에는 테이블에서 확인하지 않도록 구현할 수 있었습니다.

추가로 어떤 boards의 청첩장인지도 확인할 수 있도록 boards_id 값도 토큰에 추가했기 때문에 마찬가지로 DB 확인 없이 이후 로직을 처리할 수 있었습니다.

<br></br>























